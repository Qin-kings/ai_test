<!-- templates/app/level2_detail.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>{{ level2.level1.name }} / {{ level2.name }}</title>
</head>
<body>
  <p><a href="{% url 'Generate_testcases:level2_list' %}">← 返回列表</a></p>
  <h2>{{ level2.level1.name }} / {{ level2.name }}</h2>

  {% if messages %}
    <ul>
      {% for m in messages %}
        <li>{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <h3>种子样例（TestCaseSeed）</h3>
  
  <!-- 手动添加种子测试用例表单 -->
  <div style="background: #f0f8ff; padding: 15px; margin-bottom: 20px; border-radius: 5px; border: 2px solid #4CAF50;">
    <h4 style="margin-top: 0; color: #2E7D32;">手动添加种子测试用例</h4>
    <form method="post" style="margin-bottom: 0;">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_seed"/>
      
      <div style="margin-bottom: 10px;">
        <label for="{{ add_seed_form.text.id_for_label }}" style="font-weight: bold; display: block; margin-bottom: 5px;">
          {{ add_seed_form.text.label }}
        </label>
        {{ add_seed_form.text }}
        {% if add_seed_form.text.errors %}
          <div style="color: red; font-size: 12px; margin-top: 5px;">
            {{ add_seed_form.text.errors }}
          </div>
        {% endif %}
      </div>
      
      <button type="submit" style="background: #4CAF50; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
        添加种子用例
      </button>
    </form>
  </div>

  <!-- 现有种子列表 -->
  <h4>已有种子样例列表</h4>
  <ol>
    {% for s in seeds %}
      <li style="margin-bottom: 10px; padding: 8px; background: #fafafa; border-left: 3px solid #2196F3;">
        {{ s.text|linebreaksbr }}
        <small style="color: #666; display: block; margin-top: 5px;">
          创建时间：{{ s.created_at|date:"Y-m-d H:i" }}
        </small>
      </li>
    {% empty %}
      <li style="color: #999;">暂无种子样例</li>
    {% endfor %}
  </ol>

  <hr/>

  <h3>生成测试用例</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="generate"/>
    
    <h4>选择种子样例</h4>
    {% if seeds %}
      <div style="margin-bottom: 20px;">
        {% for seed in seeds %}
          <div style="background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-left: 3px solid #4CAF50;">
            <label style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" 
                     name="seed_{{ seed.id }}" 
                     id="id_seed_{{ seed.id }}"
                     class="seed-checkbox"
                     onchange="toggleSeedInput('seed_{{ seed.id }}_n')"
                     style="width: auto;">
              <span style="flex: 1;">{{ seed.text|linebreaksbr|truncatewords:50 }}</span>
              <label for="id_seed_{{ seed.id }}_n" style="display: inline; margin-right: 5px;">数量：</label>
              <input type="number" 
                     name="seed_{{ seed.id }}_n" 
                     id="id_seed_{{ seed.id }}_n"
                     style="width: 80px;"
                     min="1" 
                     max="50" 
                     value="5"
                     disabled>
            </label>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p style="color: #999;">该二级功能下暂无种子样例，请先添加种子样例。</p>
    {% endif %}

    <h4>生成参数</h4>
    <p>
      <label for="{{ gen_form.prompt.id_for_label }}">{{ gen_form.prompt.label }}</label>
      {{ gen_form.prompt }}
      <small style="color: #666; display: block; margin-top: 5px;">
        可选：会话级别的提示词（会覆盖场景提示词：{{ level2.prompt|default:"未设置"|truncatewords:10 }}）
      </small>
    </p>
    <p>
      <label for="{{ gen_form.temperature.id_for_label }}">{{ gen_form.temperature.label }}</label>
      {{ gen_form.temperature }}
    </p>
    <p>
      <label for="{{ gen_form.top_p.id_for_label }}">{{ gen_form.top_p.label }}</label>
      {{ gen_form.top_p }}
    </p>
    <button type="submit">生成（mock）</button>
  </form>

  <script>
    function toggleSeedInput(nFieldName) {
      const checkbox = document.querySelector(`input[name="${nFieldName.replace('_n', '')}"]`);
      const nInput = document.getElementById(`id_${nFieldName}`);
      if (checkbox && nInput) {
        nInput.disabled = !checkbox.checked;
        if (checkbox.checked) {
          nInput.focus();
        }
      }
    }

    // 表单提交前验证
    document.querySelector('form[method="post"]')?.addEventListener('submit', function(e) {
      if (this.querySelector('input[name="action"][value="generate"]')) {
        const checkedSeeds = this.querySelectorAll('.seed-checkbox:checked');
        if (checkedSeeds.length === 0) {
          e.preventDefault();
          alert('请至少选择一个种子样例！');
          return false;
        }
      }
    });
  </script>

  <hr/>

  <h3>最新生成结果</h3>
  {% if session %}
    <p>Session ID: {{ session.id }} | 创建时间：{{ session.created_at }}</p>
    {% if session.seed_configs.all %}
      <p><strong>种子配置：</strong>
        {% for config in session.seed_configs.all %}
          种子#{{ config.seed.id }}({{ config.n }}条) 
        {% endfor %}
      </p>
    {% endif %}

    <form method="post" action="{% url 'Generate_testcases:session_edit_and_save' session.id %}">
      {% csrf_token %}

      <h4>编辑 5 条（可直接改文本）</h4>
      {{ formset.management_form }}

      <ol>
        {% for f in formset %}
          <li>
            {# ✅ 关键修复：必须渲染隐藏字段，尤其是 id，否则无法更新数据库 #}
            {% for hidden in f.hidden_fields %}
              {{ hidden }}
            {% endfor %}

            <div>
              <b>raw:</b>
              <pre style="white-space: pre-wrap;">{{ f.instance.raw_text }}</pre>
            </div>

            <div>
              <b>edited:</b><br/>
              {{ f.edited_text }}
            </div>
            <hr/>
          </li>
        {% endfor %}
      </ol>

      <button type="submit" name="action" value="save_edits">保存编辑</button>

      <h4>最终保存到新表（SavedCaseSet）</h4>
      {{ save_form.as_p }}
      <button type="submit" name="action" value="final_save">最终保存</button>
    </form>

  {% else %}
    <p>还没有生成过，请先在上面输入 prompt 生成。</p>
  {% endif %}
</body>
</html>
