<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç”¨ä¾‹å·¥ä½œå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .workspace-container {
            display: flex;
            height: calc(100vh - 60px);
            gap: 0;
            margin-top: 60px;
        }

        .top-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .top-toolbar h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        .delete-mode-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-mode-btn:hover {
            background: #d32f2f;
        }

        .delete-mode-btn.cancel-mode {
            background: #9e9e9e;
        }

        .delete-mode-btn.cancel-mode:hover {
            background: #757575;
        }

        .edit-mode-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .edit-mode-btn:hover {
            background: #1976D2;
        }

        .edit-mode-btn.cancel-mode {
            background: #9e9e9e;
        }

        .edit-mode-btn.cancel-mode:hover {
            background: #757575;
        }

        .save-edit-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
            margin-left: 10px;
        }

        .save-edit-btn:hover {
            background: #45a049;
        }

        .save-edit-btn.show {
            display: block;
        }

        .confirm-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }

        .confirm-delete-btn:hover {
            background: #d32f2f;
        }

        .confirm-delete-btn.show {
            display: block;
        }

        .panel {
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 2px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .panel-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .add-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .list-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-checkbox {
            display: none;
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-left: 10px;
        }

        .delete-mode .list-item-checkbox {
            display: block;
        }

        .view-prompt-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .view-prompt-btn:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        .list-item:hover {
            background: #f5f5f5;
        }

        .list-item.active {
            background: #e8f5e9;
            border-left-color: #4CAF50;
            font-weight: 500;
        }

        .list-item-name {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            outline: none;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .list-item-name.editable {
            cursor: text;
        }

        .list-item-name.editable:hover {
            background: #f5f5f5;
        }

        .list-item-name.editable:focus {
            background: #fff;
            box-shadow: 0 0 0 2px #2196F3;
        }

        .list-item-name.editing {
            background: #e3f2fd;
        }

        .list-item-meta {
            font-size: 12px;
            color: #999;
        }

        /* å·¦ä¾§é¢æ¿ - ä¸€çº§åŠŸèƒ½ */
        .level1-panel {
            width: 280px;
            min-width: 280px;
        }

        /* ä¸­é—´é¢æ¿ - äºŒçº§åŠŸèƒ½ */
        .level2-panel {
            width: 300px;
            min-width: 300px;
        }

        /* å³ä¾§é¢æ¿ - ç§å­å’Œç”Ÿæˆ */
        .seed-panel {
            flex: 1;
            border-right: none;
        }

        .seed-panel .panel-content {
            padding: 0;
        }

        .seed-table-container {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .seed-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 900px;
        }

        .seed-table thead {
            position: sticky;
            top: 0;
            background: #fafafa;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .seed-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
        }

        .seed-table th:first-child {
            width: 50px;
            text-align: center;
        }

        .seed-table th:nth-child(2) {
            width: 60px;
            text-align: center;
        }

        .seed-table th:nth-child(3) {
            min-width: 300px;
        }

        .seed-table th:nth-child(4) {
            width: 120px;
            text-align: center;
        }

        .seed-table th:nth-child(5) {
            width: 180px;
            text-align: center;
        }

        .seed-table th:nth-child(6) {
            width: 140px;
            text-align: center;
        }

        .seed-table tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s;
        }

        .seed-table tbody tr:hover {
            background: #f9f9f9;
        }

        .seed-table tbody tr.selected {
            background: #e3f2fd !important;
        }

        .seed-table td {
            padding: 12px 10px;
            vertical-align: middle;
        }

        .seed-table .seed-number {
            text-align: center;
            font-weight: 500;
            color: #666;
        }

        .seed-table .seed-content {
            color: #333;
            line-height: 1.6;
            max-width: 500px;
            white-space: pre-wrap;
            word-break: break-word;
            outline: none;
            padding: 4px 6px;
            border-radius: 3px;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .seed-table .seed-content.editable {
            cursor: text;
        }

        .seed-table .seed-content.editable:hover {
            background: #f0f0f0;
        }

        .seed-table .seed-content.editable:focus {
            background: #fff;
            box-shadow: 0 0 0 2px #2196F3;
        }

        .seed-table .seed-content.editing {
            background: #e3f2fd;
        }

        .seed-table .seed-quantity {
            text-align: center;
        }

        .seed-table .seed-quantity input {
            width: 70px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .seed-table .seed-actions {
            text-align: center;
        }

        .seed-action-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            width: 140px;
            margin: 0 auto;
        }

        .seed-action-btn {
            padding: 5px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
            white-space: nowrap;
        }

        .seed-action-btn:hover {
            background: #f5f5f5;
            border-color: #2196F3;
            color: #2196F3;
        }

        .seed-action-btn.btn-generate {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .seed-action-btn.btn-generate:hover {
            background: #4CAF50;
            color: white;
        }

        .seed-action-btn.btn-delete {
            border-color: #f44336;
            color: #f44336;
        }

        .seed-action-btn.btn-delete:hover {
            background: #f44336;
            color: white;
        }

        .seed-table .seed-time {
            text-align: center;
            color: #999;
            font-size: 12px;
        }

        .seed-select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        {#.select-all-btn {#}
        {#  background: #2196F3;#}
        {#  color: white;#}
        {#  border: none;#}
        {#  padding: 8px 16px;#}
        {#  border-radius: 6px;#}
        {#  font-size: 13px;#}
        {#  cursor: pointer;#}
        {#  transition: all 0.2s;#}
        {#  margin-left: 0px;#}

        .select-all-btn {
            background: #2196F3;
            color: white;
            border: none;

            height: 32px; /* âœ… å’Œ + æŒ‰é’®ä¸€è‡´ */
            padding: 0 14px; /* â— åªä¿ç•™å·¦å³ padding */
            line-height: 32px; /* âœ… æ–‡æœ¬å‚ç›´å±…ä¸­ */

            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 0;
        }


        .select-all-btn:hover {
            background: #1976D2;
        }

        .generate-section {
            background: white;
            border-top: 2px solid #4CAF50;
            padding: 20px;
            position: sticky;
            bottom: 0;
        }

        .generate-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .param-group {
            display: flex;
            flex-direction: column;
        }

        .param-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .param-group input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .generate-btn {
            width: 100%;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .generate-btn:hover {
            background: #45a049;
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .batch-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 12px;
        }

        .batch-delete-btn:hover {
            background: #d32f2f;
        }

        .batch-delete-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Modalæ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: none;
        }

        .message.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .message.success {
            background: #4CAF50;
            color: white;
        }

        .message.error {
            background: #f44336;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .panel-header-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* æ§åˆ¶â€œå…¨é€‰â€å’Œâ€œ+â€é—´è· */
        }
    </style>
</head>
<body>
<!-- é¡¶éƒ¨å·¥å…·æ  -->
<div class="top-toolbar">
    <h2>æµ‹è¯•ç”¨ä¾‹å·¥ä½œå°</h2>
    <div class="toolbar-actions">
        <button class="edit-mode-btn" id="editModeBtn" onclick="toggleEditMode()">ç¼–è¾‘</button>
        <button class="save-edit-btn" id="saveEditBtn" onclick="saveEdits()">ä¿å­˜ä¿®æ”¹</button>
        <button class="delete-mode-btn" id="deleteModeBtn" onclick="toggleDeleteMode()">åˆ é™¤</button>
        <button class="confirm-delete-btn" id="confirmDeleteBtn" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
        <button class="import-btn" id="importBtn" onclick="triggerImport()">å¯¼å…¥</button>
        <input type="file" id="importFileInput" accept=".xlsx" style="display:none" onchange="uploadImportFile(event)">

    </div>
</div>

<div class="workspace-container" id="workspaceContainer">
    <!-- å·¦ä¾§ï¼šä¸€çº§åŠŸèƒ½åˆ—è¡¨ -->
    <div class="panel level1-panel">
        <div class="panel-header">
            <h3>ä¸€çº§åŠŸèƒ½</h3>
            <button class="add-btn" onclick="showAddLevel1Modal()" title="æ·»åŠ ä¸€çº§åŠŸèƒ½">+</button>
        </div>
        <div class="panel-content" id="level1List">
            {% for level1 in level1_list %}
                <div class="list-item" data-id="{{ level1.id }}" onclick="selectLevel1({{ level1.id }}, this)">
                    <div class="list-item-content">
                        <div class="list-item-name" data-type="level1" data-id="{{ level1.id }}"
                             data-original="{{ level1.name }}">{{ level1.name }}</div>
                        {% if level1.code %}
                            <div class="list-item-meta">ç¼–ç : {{ level1.code }}</div>
                        {% endif %}
                    </div>
                    <input type="checkbox" class="list-item-checkbox" data-type="level1" data-id="{{ level1.id }}"
                           onclick="event.stopPropagation()">
                </div>
            {% empty %}
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>æš‚æ— ä¸€çº§åŠŸèƒ½<br>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- ä¸­é—´ï¼šäºŒçº§åŠŸèƒ½åˆ—è¡¨ -->
    <div class="panel level2-panel">
        <div class="panel-header">
            <h3>äºŒçº§åŠŸèƒ½</h3>
            <button class="add-btn" id="addLevel2Btn" onclick="showAddLevel2Modal()" title="æ·»åŠ äºŒçº§åŠŸèƒ½" disabled>+
            </button>
        </div>
        <div class="panel-content" id="level2List">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <p>è¯·å…ˆé€‰æ‹©ä¸€çº§åŠŸèƒ½</p>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç§å­æµ‹è¯•ç”¨ä¾‹å’Œç”Ÿæˆ -->
    <div class="panel seed-panel">
        <div class="panel-header">
            <h3>ç§å­æµ‹è¯•ç”¨ä¾‹</h3>
            <div class="panel-header-actions">
                <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()" disabled>å…¨é€‰</button>
                <button class="add-btn" id="addSeedBtn" onclick="showAddSeedModal()" title="æ·»åŠ ç§å­ç”¨ä¾‹" disabled>+
                </button>
            </div>
        </div>


        <!-- ç§å­åˆ—è¡¨ -->
        <div class="panel-content" id="seedList">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸŒ±</div>
                <p>è¯·å…ˆé€‰æ‹©äºŒçº§åŠŸèƒ½</p>
            </div>
        </div>

        <!-- ç”ŸæˆæŒ‰é’®åŒº -->
        <div class="generate-section" id="generateSection" style="display: none;">
            <div class="generate-params">
                <div class="param-group">
                    <label>Temperature</label>
                    <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2">
                </div>
                <div class="param-group">
                    <label>Top P</label>
                    <input type="number" id="topP" value="1.0" step="0.1" min="0" max="1">
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="generate-btn" onclick="generateTestcases()" style="flex: 1;">ç”Ÿæˆæ³›åŒ–ç”¨ä¾‹</button>
                <button class="batch-delete-btn" onclick="batchDeleteSeeds()" id="batchDeleteBtn" disabled>æ‰¹é‡åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ ä¸€çº§åŠŸèƒ½æ¨¡æ€æ¡† -->
<div class="modal" id="addLevel1Modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ·»åŠ ä¸€çº§åŠŸèƒ½</h3>
            <button class="modal-close" onclick="closeModal('addLevel1Modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>åç§° <span style="color: red;">*</span></label>
                <input type="text" id="level1Name" placeholder="è¾“å…¥ä¸€çº§åŠŸèƒ½åç§°">
            </div>
            <div class="form-group">
                <label>ç¼–ç </label>
                <input type="text" id="level1Code" placeholder="å¯é€‰ï¼šç¼–ç /ä¸šåŠ¡Key">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addLevel1Modal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitAddLevel1()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- æ·»åŠ äºŒçº§åŠŸèƒ½æ¨¡æ€æ¡† -->
<div class="modal" id="addLevel2Modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ·»åŠ äºŒçº§åŠŸèƒ½</h3>
            <button class="modal-close" onclick="closeModal('addLevel2Modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>åç§° <span style="color: red;">*</span></label>
                <input type="text" id="level2Name" placeholder="è¾“å…¥äºŒçº§åŠŸèƒ½åç§°">
            </div>
            <div class="form-group">
                <label>ç¼–ç </label>
                <input type="text" id="level2Code" placeholder="å¯é€‰ï¼šç¼–ç ">
            </div>
            <div class="form-group">
                <label>åœºæ™¯æç¤ºè¯</label>
                <textarea id="level2Prompt" placeholder="è¾“å…¥è¯¥äºŒçº§åŠŸèƒ½ï¼ˆåœºæ™¯ï¼‰çš„æç¤ºè¯"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addLevel2Modal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitAddLevel2()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- æ·»åŠ ç§å­ç”¨ä¾‹æ¨¡æ€æ¡† -->
<div class="modal" id="addSeedModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ·»åŠ ç§å­æµ‹è¯•ç”¨ä¾‹</h3>
            <button class="modal-close" onclick="closeModal('addSeedModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æµ‹è¯•ç”¨ä¾‹å†…å®¹ <span style="color: red;">*</span></label>
                <textarea id="seedText" placeholder="è¾“å…¥æµ‹è¯•ç”¨ä¾‹å†…å®¹..." rows="6"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addSeedModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitAddSeed()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹/ç¼–è¾‘æç¤ºè¯æ¨¡æ€æ¡† -->
<div class="modal" id="promptModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>åœºæ™¯æç¤ºè¯</h3>
            <button class="modal-close" onclick="closeModal('promptModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>äºŒçº§åŠŸèƒ½åç§°</label>
                <input type="text" id="promptLevel2Name" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label>æç¤ºè¯å†…å®¹</label>
                <textarea id="promptContent" rows="8" readonly style="background: #f5f5f5;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('promptModal')">è¿”å›</button>
            <button class="btn btn-primary" id="editPromptBtn" onclick="togglePromptEdit()">ç¼–è¾‘</button>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯æç¤º -->
<div class="message" id="message"></div>

<script>
    // å…¨å±€çŠ¶æ€
    let currentLevel1Id = null;
    let currentLevel2Id = null;
    let deleteMode = false;
    let editMode = false;
    let editedItems = new Map(); // å­˜å‚¨ä¿®æ”¹çš„å†…å®¹

    // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
    function toggleEditMode() {
        editMode = !editMode;
        const editModeBtn = document.getElementById('editModeBtn');
        const saveBtn = document.getElementById('saveEditBtn');

        if (editMode) {
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            editModeBtn.classList.add('cancel-mode');
            editModeBtn.textContent = 'å–æ¶ˆç¼–è¾‘';
            saveBtn.classList.add('show');

            // å¯ç”¨æ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ 
            enableEditing();
        } else {
            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            editModeBtn.classList.remove('cancel-mode');
            editModeBtn.textContent = 'ç¼–è¾‘';
            saveBtn.classList.remove('show');

            // ç¦ç”¨ç¼–è¾‘å¹¶æ¢å¤åŸå§‹å†…å®¹
            disableEditing();
            editedItems.clear();
        }
    }

    // å¯ç”¨ç¼–è¾‘
    function enableEditing() {
        // ä¸€çº§åŠŸèƒ½åç§°
        document.querySelectorAll('.list-item-name[data-type="level1"]').forEach(el => {
            el.contentEditable = true;
            el.classList.add('editable');
            el.addEventListener('input', onLevel1NameChange);
        });

        // äºŒçº§åŠŸèƒ½åç§°
        document.querySelectorAll('.list-item-name[data-type="level2"]').forEach(el => {
            el.contentEditable = true;
            el.classList.add('editable');
            el.addEventListener('input', onLevel2NameChange);
        });

        // ç§å­æµ‹è¯•ç”¨ä¾‹ä¸å†é€šè¿‡é¡¶éƒ¨ç¼–è¾‘æŒ‰é’®æ§åˆ¶ï¼Œä½¿ç”¨æ“ä½œæ ä¸­çš„ç¼–è¾‘æŒ‰é’®
    }

    // ç¦ç”¨ç¼–è¾‘
    function disableEditing() {
        // ä¸€çº§åŠŸèƒ½åç§°
        document.querySelectorAll('.list-item-name[data-type="level1"]').forEach(el => {
            el.contentEditable = false;
            el.classList.remove('editable', 'editing');
            el.textContent = el.dataset.original;
            el.removeEventListener('input', onLevel1NameChange);
        });

        // äºŒçº§åŠŸèƒ½åç§°
        document.querySelectorAll('.list-item-name[data-type="level2"]').forEach(el => {
            el.contentEditable = false;
            el.classList.remove('editable', 'editing');
            el.textContent = el.dataset.original;
            el.removeEventListener('input', onLevel2NameChange);
        });

        // ç§å­æµ‹è¯•ç”¨ä¾‹ä¸å†é€šè¿‡é¡¶éƒ¨ç¼–è¾‘æŒ‰é’®æ§åˆ¶
    }

    // ç›‘å¬ä¸€çº§åŠŸèƒ½åç§°å˜åŒ–
    function onLevel1NameChange(e) {
        const el = e.target;
        const id = el.dataset.id;
        const newName = el.textContent.trim();
        el.classList.add('editing');
        editedItems.set(`level1_${id}`, {type: 'level1', id, name: newName});
    }

    // ç›‘å¬äºŒçº§åŠŸèƒ½åç§°å˜åŒ–
    function onLevel2NameChange(e) {
        const el = e.target;
        const id = el.dataset.id;
        const newName = el.textContent.trim();
        el.classList.add('editing');

        // è·å–å½“å‰å­˜å‚¨çš„é¡¹ï¼ˆå¯èƒ½å·²ç»åŒ…å«promptï¼‰
        const existingItem = editedItems.get(`level2_${id}`);

        editedItems.set(`level2_${id}`, {
            type: 'level2',
            id,
            name: newName,
            prompt: existingItem?.prompt // ä¿ç•™å·²æœ‰çš„promptä¿®æ”¹
        });
    }

    // ç§å­å†…å®¹ä¸å†é€šè¿‡é¡¶éƒ¨ç¼–è¾‘æ¨¡å¼æ§åˆ¶ï¼Œä½¿ç”¨æ“ä½œæ ä¸­çš„ç¼–è¾‘æŒ‰é’®

    // ä¿å­˜æ‰€æœ‰ä¿®æ”¹ï¼ˆä¸å†åŒ…å«ç§å­ï¼‰
    async function saveEdits() {
        if (editedItems.size === 0) {
            showMessage('æ²¡æœ‰éœ€è¦ä¿å­˜çš„ä¿®æ”¹', 'info');
            return;
        }

        const updates = Array.from(editedItems.values());
        let successCount = 0;
        let errorCount = 0;

        for (const item of updates) {
            try {
                if (item.type === 'level1') {
                    await updateLevel1(item.id, item.name);
                } else if (item.type === 'level2') {
                    await updateLevel2(item.id, item.name, item.prompt);
                }
                // ç§å­ä¸å†é€šè¿‡è¿™é‡Œä¿å­˜
                successCount++;
            } catch (err) {
                errorCount++;
                console.error('ä¿å­˜å¤±è´¥:', err);
            }
        }

        if (errorCount === 0) {
            showMessage(`æˆåŠŸä¿å­˜ ${successCount} é¡¹ä¿®æ”¹`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(`ä¿å­˜å®Œæˆï¼šæˆåŠŸ ${successCount} é¡¹ï¼Œå¤±è´¥ ${errorCount} é¡¹`, 'warning');
            setTimeout(() => location.reload(), 2000);
        }
    }

    // æ›´æ–°ä¸€çº§åŠŸèƒ½
    function updateLevel1(id, name) {
        return fetch('/Generate_testcases/api/update-level1/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({id, name})
        }).then(res => res.json()).then(data => {
            if (data.error) throw new Error(data.error);
        });
    }

    // æ›´æ–°äºŒçº§åŠŸèƒ½
    function updateLevel2(id, name, prompt) {
        return fetch('/Generate_testcases/api/update-level2/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({id, name, prompt})
        }).then(res => res.json()).then(data => {
            if (data.error) throw new Error(data.error);
        });
    }

    // updateSeedå‡½æ•°å·²ç§»é™¤ï¼Œç§å­ç¼–è¾‘é€šè¿‡æ“ä½œæ çš„ç¼–è¾‘æŒ‰é’®å®Œæˆ

    // åˆ‡æ¢åˆ é™¤æ¨¡å¼
    function toggleDeleteMode() {
        deleteMode = !deleteMode;
        const container = document.getElementById('workspaceContainer');
        const deleteModeBtn = document.getElementById('deleteModeBtn');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        if (deleteMode) {
            container.classList.add('delete-mode');
            deleteModeBtn.classList.add('cancel-mode');
            deleteModeBtn.textContent = 'å–æ¶ˆ';
            confirmBtn.classList.add('show');
        } else {
            container.classList.remove('delete-mode');
            deleteModeBtn.classList.remove('cancel-mode');
            deleteModeBtn.textContent = 'åˆ é™¤';
            confirmBtn.classList.remove('show');
            // å–æ¶ˆæ‰€æœ‰é€‰ä¸­
            document.querySelectorAll('.list-item-checkbox, .seed-delete-checkbox').forEach(cb => cb.checked = false);
        }
    }

    // ç¡®è®¤åˆ é™¤
    function confirmDelete() {
        const level1Ids = [];
        const level2Ids = [];

        // æ”¶é›†é€‰ä¸­çš„é¡¹ï¼ˆä¸å†æ”¶é›†ç§å­ï¼‰
        document.querySelectorAll('.list-item-checkbox:checked').forEach(cb => {
            const type = cb.dataset.type;
            const id = parseInt(cb.dataset.id);
            if (type === 'level1') level1Ids.push(id);
            if (type === 'level2') level2Ids.push(id);
        });

        if (level1Ids.length === 0 && level2Ids.length === 0) {
            showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹è¦åˆ é™¤çš„å†…å®¹', 'error');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${level1Ids.length + level2Ids.length} é¡¹å—ï¼Ÿ\nåˆ é™¤ä¸€çº§åŠŸèƒ½ä¼šåŒæ—¶åˆ é™¤å…¶ä¸‹çš„æ‰€æœ‰äºŒçº§åŠŸèƒ½å’Œç§å­ã€‚\nåˆ é™¤äºŒçº§åŠŸèƒ½ä¼šåŒæ—¶åˆ é™¤å…¶ä¸‹çš„æ‰€æœ‰ç§å­ã€‚`)) {
            return;
        }

        fetch('/Generate_testcases/api/delete-items/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                level1_ids: level1Ids,
                level2_ids: level2Ids,
                seed_ids: []
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    // åˆ·æ–°é¡µé¢
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(err => showMessage('åˆ é™¤å¤±è´¥', 'error'));
    }

    // é€‰æ‹©ä¸€çº§åŠŸèƒ½
    function selectLevel1(id, element) {
        currentLevel1Id = id;
        currentLevel2Id = null;

        // æ›´æ–°UI
        document.querySelectorAll('.level1-panel .list-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // å¯ç”¨æ·»åŠ äºŒçº§åŠŸèƒ½æŒ‰é’®
        document.getElementById('addLevel2Btn').disabled = false;

        // åŠ è½½äºŒçº§åŠŸèƒ½åˆ—è¡¨
        loadLevel2List(id);

        // æ¸…ç©ºç§å­åˆ—è¡¨
        clearSeedPanel();
    }

    // åŠ è½½äºŒçº§åŠŸèƒ½åˆ—è¡¨
    function loadLevel2List(level1Id) {
        fetch(`/Generate_testcases/api/get-level2-list/?level1_id=${level1Id}`)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('level2List');
                if (data.level2_list && data.level2_list.length > 0) {
                    container.innerHTML = data.level2_list.map(l2 => `
              <div class="list-item" data-id="${l2.id}" onclick="selectLevel2(${l2.id}, this)">
                <div class="list-item-content">
                  <div class="list-item-name" data-type="level2" data-id="${l2.id}" data-original="${l2.name}">${l2.name}</div>
                  ${l2.prompt ? `<div class="list-item-meta">å·²è®¾ç½®æç¤ºè¯</div>` : ''}
                </div>
                <button class="view-prompt-btn" onclick="viewPrompt(${l2.id}, '${l2.name.replace(/'/g, "\\'")}', '${(l2.prompt || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', event)" title="æŸ¥çœ‹æç¤ºè¯">ğŸ‘ï¸</button>
                <input type="checkbox" class="list-item-checkbox" data-type="level2" data-id="${l2.id}" onclick="event.stopPropagation()">
              </div>
            `).join('');

                    // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå¯ç”¨æ–°åŠ è½½çš„å…ƒç´ 
                    if (editMode) {
                        container.querySelectorAll('.list-item-name[data-type="level2"]').forEach(el => {
                            el.contentEditable = true;
                            el.classList.add('editable');
                            el.addEventListener('input', onLevel2NameChange);
                        });
                    }
                } else {
                    container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <p>æš‚æ— äºŒçº§åŠŸèƒ½<br>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
              </div>
            `;
                }
            })
            .catch(err => showMessage('åŠ è½½äºŒçº§åŠŸèƒ½åˆ—è¡¨å¤±è´¥', 'error'));
    }

    // é€‰æ‹©äºŒçº§åŠŸèƒ½
    function selectLevel2(id, element) {
        currentLevel2Id = id;

        // æ›´æ–°UI
        document.querySelectorAll('.level2-panel .list-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // å¯ç”¨æ·»åŠ ç§å­æŒ‰é’®
        document.getElementById('addSeedBtn').disabled = false;

        // åŠ è½½ç§å­åˆ—è¡¨
        loadSeedList(id);
    }

    // åŠ è½½ç§å­åˆ—è¡¨
    function loadSeedList(level2Id) {
        fetch(`/Generate_testcases/api/get-seed-list/?level2_id=${level2Id}`)
            .then(res => res.json())
            .then(data => {
                // æ˜¾ç¤ºç§å­åˆ—è¡¨
                const container = document.getElementById('seedList');
                if (data.seed_list && data.seed_list.length > 0) {
                    container.innerHTML = `
              <div class="seed-table-container">
                <table class="seed-table">
                  <thead>
                    <tr>
                      <th>é€‰ä¸­</th>
                      <th>åºå·</th>
                      <th>ç§å­ç”¨ä¾‹</th>
                      <th>ç”Ÿæˆæ•°é‡</th>
                      <th>æ“ä½œæ </th>
                      <th>å¯¼å…¥æ—¶é—´</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.seed_list.map((seed, index) => `
                      <tr data-seed-id="${seed.id}">
                        <td style="text-align: center;">
                          <input type="checkbox" class="seed-select-checkbox" data-seed-id="${seed.id}" onchange="toggleSeedSelection(${seed.id})">
                        </td>
                        <td class="seed-number">${index + 1}</td>
                        <td>
                          <div class="seed-content" data-seed-id="${seed.id}" data-original="${seed.text.replace(/"/g, '&quot;')}" contenteditable="false">${seed.text}</div>
                        </td>
                        <td class="seed-quantity">
                          <input type="number" class="seed-n-input" data-seed-id="${seed.id}" value="5" min="0" max="50">
                        </td>
                        <td class="seed-actions">
                          <div class="seed-action-btns">
                            <button class="seed-action-btn btn-generate" data-seed-id="${seed.id}" onclick="generateFromSeed(${seed.id})">ç”Ÿæˆ</button>
                            <button class="seed-action-btn" data-seed-id="${seed.id}" onclick="editSeedContent(${seed.id})">ç¼–è¾‘</button>
                            <button class="seed-action-btn" data-seed-id="${seed.id}" onclick="copySeedText(${seed.id})">å¤åˆ¶</button>
                            <button class="seed-action-btn btn-delete" data-seed-id="${seed.id}" onclick="deleteSingleSeed(${seed.id})">åˆ é™¤</button>
                          </div>
                        </td>
                        <td class="seed-time">${seed.created_at}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;

                    // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå¯ç”¨ç§å­å†…å®¹ç¼–è¾‘
                    if (editMode) {
                        document.querySelectorAll('.seed-content[data-seed-id]').forEach(el => {
                            el.contentEditable = true;
                            el.classList.add('editable');
                            el.addEventListener('input', onSeedContentChange);
                        });
                    }

                    // æ˜¾ç¤ºç”ŸæˆåŒºåŸŸ
                    document.getElementById('generateSection').style.display = 'block';

                    // å¯ç”¨å…¨é€‰æŒ‰é’®ï¼Œæ‰¹é‡åˆ é™¤æŒ‰é’®åˆå§‹ç¦ç”¨
                    document.getElementById('selectAllBtn').disabled = false;
                    document.getElementById('batchDeleteBtn').disabled = true;
                } else {
                    container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸŒ±</div>
                <p>æš‚æ— ç§å­æµ‹è¯•ç”¨ä¾‹<br>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
              </div>
            `;
                    document.getElementById('generateSection').style.display = 'none';
                    document.getElementById('selectAllBtn').disabled = true;
                    document.getElementById('batchDeleteBtn').disabled = true;
                }
            })
            .catch(err => showMessage('åŠ è½½ç§å­åˆ—è¡¨å¤±è´¥', 'error'));
    }

    // æ¸…ç©ºç§å­é¢æ¿
    function clearSeedPanel() {
        document.getElementById('seedList').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸŒ±</div>
          <p>è¯·å…ˆé€‰æ‹©äºŒçº§åŠŸèƒ½</p>
        </div>
      `;
        document.getElementById('generateSection').style.display = 'none';
        document.getElementById('addSeedBtn').disabled = true;
        document.getElementById('selectAllBtn').disabled = true;
        document.getElementById('batchDeleteBtn').disabled = true;
    }

    // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€ï¼ˆå·²ç§»é™¤ï¼Œç§å­é€‰æ‹©é€šè¿‡è¾“å…¥æ•°é‡æ¥ç¡®å®šï¼‰
    function updateGenerateBtn() {
        // ä¸å†éœ€è¦æ­¤å‡½æ•°ï¼Œä½†ä¿ç•™ä»¥é¿å…è°ƒç”¨é”™è¯¯
    }

    // Modalæ“ä½œ
    function showAddLevel1Modal() {
        document.getElementById('level1Name').value = '';
        document.getElementById('level1Code').value = '';
        document.getElementById('addLevel1Modal').classList.add('show');
    }

    function showAddLevel2Modal() {
        if (!currentLevel1Id) {
            showMessage('è¯·å…ˆé€‰æ‹©ä¸€çº§åŠŸèƒ½', 'error');
            return;
        }
        document.getElementById('level2Name').value = '';
        document.getElementById('level2Code').value = '';
        document.getElementById('level2Prompt').value = '';
        document.getElementById('addLevel2Modal').classList.add('show');
    }

    function showAddSeedModal() {
        if (!currentLevel2Id) {
            showMessage('è¯·å…ˆé€‰æ‹©äºŒçº§åŠŸèƒ½', 'error');
            return;
        }
        document.getElementById('seedText').value = '';
        document.getElementById('addSeedModal').classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // æäº¤æ·»åŠ ä¸€çº§åŠŸèƒ½
    function submitAddLevel1() {
        const name = document.getElementById('level1Name').value.trim();
        const code = document.getElementById('level1Code').value.trim();

        if (!name) {
            showMessage('è¯·è¾“å…¥åç§°', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('code', code);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('/Generate_testcases/api/add-level1/', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    closeModal('addLevel1Modal');
                    // åˆ·æ–°åˆ—è¡¨
                    location.reload();
                }
            })
            .catch(err => showMessage('æ·»åŠ å¤±è´¥', 'error'));
    }

    // æäº¤æ·»åŠ äºŒçº§åŠŸèƒ½
    function submitAddLevel2() {
        const name = document.getElementById('level2Name').value.trim();
        const code = document.getElementById('level2Code').value.trim();
        const prompt = document.getElementById('level2Prompt').value.trim();

        if (!name) {
            showMessage('è¯·è¾“å…¥åç§°', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('level1_id', currentLevel1Id);
        formData.append('name', name);
        formData.append('code', code);
        formData.append('prompt', prompt);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('/Generate_testcases/api/add-level2/', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    closeModal('addLevel2Modal');
                    // åˆ·æ–°äºŒçº§åŠŸèƒ½åˆ—è¡¨
                    loadLevel2List(currentLevel1Id);
                }
            })
            .catch(err => showMessage('æ·»åŠ å¤±è´¥', 'error'));
    }

    // æäº¤æ·»åŠ ç§å­ç”¨ä¾‹
    function submitAddSeed() {
        const text = document.getElementById('seedText').value.trim();

        if (!text) {
            showMessage('è¯·è¾“å…¥æµ‹è¯•ç”¨ä¾‹å†…å®¹', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('level2_id', currentLevel2Id);
        formData.append('text', text);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('/Generate_testcases/api/add-seed/', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    closeModal('addSeedModal');
                    // åˆ·æ–°ç§å­åˆ—è¡¨
                    loadSeedList(currentLevel2Id);
                }
            })
            .catch(err => showMessage('æ·»åŠ å¤±è´¥', 'error'));
    }

    // æŸ¥çœ‹æç¤ºè¯
    function viewPrompt(level2Id, level2Name, prompt, event) {
        event.stopPropagation(); // é˜»æ­¢è§¦å‘selectLevel2

        // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
        document.getElementById('promptLevel2Name').value = level2Name;
        document.getElementById('promptContent').value = prompt || '';

        // å­˜å‚¨å½“å‰ç¼–è¾‘çš„level2Id
        document.getElementById('promptModal').dataset.level2Id = level2Id;

        // é‡ç½®ä¸ºåªè¯»æ¨¡å¼
        const promptContent = document.getElementById('promptContent');
        const editBtn = document.getElementById('editPromptBtn');
        promptContent.readOnly = true;
        promptContent.style.background = '#f5f5f5';
        editBtn.textContent = 'ç¼–è¾‘';
        editBtn.onclick = togglePromptEdit;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('promptModal').classList.add('show');
    }

    // åˆ‡æ¢æç¤ºè¯ç¼–è¾‘æ¨¡å¼
    function togglePromptEdit() {
        const promptContent = document.getElementById('promptContent');
        const editBtn = document.getElementById('editPromptBtn');

        if (promptContent.readOnly) {
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            promptContent.readOnly = false;
            promptContent.style.background = '#fff';
            promptContent.focus();
            editBtn.textContent = 'ä¿å­˜';
            editBtn.onclick = savePromptEdit;
        }
    }

    // ä¿å­˜æç¤ºè¯ç¼–è¾‘
    async function savePromptEdit() {
        const modal = document.getElementById('promptModal');
        const level2Id = modal.dataset.level2Id;
        const promptContent = document.getElementById('promptContent').value.trim();
        const level2Name = document.getElementById('promptLevel2Name').value;

        try {
            const response = await fetch('/Generate_testcases/api/update-level2/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    id: level2Id,
                    name: level2Name,
                    prompt: promptContent
                })
            });

            const data = await response.json();

            if (data.error) {
                showMessage(data.error, 'error');
            } else {
                showMessage('æç¤ºè¯ä¿å­˜æˆåŠŸ', 'success');

                // åˆ‡æ¢å›åªè¯»æ¨¡å¼
                const promptContentEl = document.getElementById('promptContent');
                const editBtn = document.getElementById('editPromptBtn');
                promptContentEl.readOnly = true;
                promptContentEl.style.background = '#f5f5f5';
                editBtn.textContent = 'ç¼–è¾‘';
                editBtn.onclick = togglePromptEdit;

                // æ›´æ–°äºŒçº§åŠŸèƒ½åˆ—è¡¨ä¸­çš„æç¤ºè¯çŠ¶æ€
                if (currentLevel1Id) {
                    loadLevel2List(currentLevel1Id);
                }
            }
        } catch (err) {
            showMessage('ä¿å­˜å¤±è´¥', 'error');
        }
    }

    // æ‰¹é‡ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
    function generateTestcases() {
        // ä¼˜å…ˆä½¿ç”¨é€‰ä¸­çš„ç§å­
        const checkedBoxes = document.querySelectorAll('.seed-select-checkbox:checked');
        const seedConfigs = [];

        if (checkedBoxes.length > 0) {
            // å¦‚æœæœ‰é€‰ä¸­çš„ç§å­ï¼Œåªä½¿ç”¨é€‰ä¸­çš„
            checkedBoxes.forEach(cb => {
                const seedId = cb.dataset.seedId;
                const nInput = document.querySelector(`.seed-n-input[data-seed-id="${seedId}"]`);
                const n = parseInt(nInput.value);
                if (n > 0) {
                    seedConfigs.push({seed_id: parseInt(seedId), n: n});
                }
            });

            if (seedConfigs.length === 0) {
                showMessage('é€‰ä¸­çš„ç§å­ç”Ÿæˆæ•°é‡å¿…é¡»å¤§äº0', 'error');
                return;
            }
        } else {
            // å¦‚æœæ²¡æœ‰é€‰ä¸­ï¼Œä½¿ç”¨æ‰€æœ‰ç”Ÿæˆæ•°é‡>0çš„ç§å­
            const nInputs = document.querySelectorAll('.seed-n-input');
            nInputs.forEach(input => {
                const n = parseInt(input.value);
                if (n > 0) {
                    const seedId = input.dataset.seedId;
                    seedConfigs.push({seed_id: parseInt(seedId), n: n});
                }
            });

            if (seedConfigs.length === 0) {
                showMessage('è¯·è‡³å°‘ä¸ºä¸€ä¸ªç§å­è®¾ç½®ç”Ÿæˆæ•°é‡ï¼ˆå¤§äº0ï¼‰æˆ–é€‰ä¸­ç§å­', 'error');
                return;
            }
        }

        const formData = new FormData();
        formData.append('level2_id', currentLevel2Id);
        formData.append('seed_configs', JSON.stringify(seedConfigs));
        formData.append('prompt', '');
        formData.append('temperature', document.getElementById('temperature').value);
        formData.append('top_p', document.getElementById('topP').value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('/Generate_testcases/api/workspace-generate/', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = `/Generate_testcases/level2/${data.level2_id}/`;
                    }, 1000);
                }
            })
            .catch(err => showMessage('ç”Ÿæˆå¤±è´¥', 'error'));
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    let allSelected = false;

    function toggleSelectAll() {
        allSelected = !allSelected;
        const checkboxes = document.querySelectorAll('.seed-select-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = allSelected;
            toggleSeedSelection(cb.dataset.seedId);
        });

        const btn = document.getElementById('selectAllBtn');
        btn.textContent = allSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰';

        updateBatchDeleteBtn();
    }

    // åˆ‡æ¢ç§å­é€‰ä¸­çŠ¶æ€
    function toggleSeedSelection(seedId) {
        const row = document.querySelector(`tr[data-seed-id="${seedId}"]`);
        const checkbox = document.querySelector(`.seed-select-checkbox[data-seed-id="${seedId}"]`);

        if (checkbox.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }

        updateBatchDeleteBtn();
    }

    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteBtn() {
        const checkedCount = document.querySelectorAll('.seed-select-checkbox:checked').length;
        const btn = document.getElementById('batchDeleteBtn');
        btn.disabled = checkedCount === 0;
        btn.textContent = checkedCount > 0 ? `æ‰¹é‡åˆ é™¤ (${checkedCount})` : 'æ‰¹é‡åˆ é™¤';
    }

    // ä»å•ä¸ªç§å­ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
    async function generateFromSeed(seedId) {
        const nInput = document.querySelector(`.seed-n-input[data-seed-id="${seedId}"]`);
        const n = parseInt(nInput.value);

        if (n <= 0) {
            showMessage('è¯·è®¾ç½®ç”Ÿæˆæ•°é‡å¤§äº0', 'error');
            return;
        }

        const seedConfigs = [{seed_id: seedId, n: n}];

        const formData = new FormData();
        formData.append('level2_id', currentLevel2Id);
        formData.append('seed_configs', JSON.stringify(seedConfigs));
        formData.append('prompt', '');
        formData.append('temperature', document.getElementById('temperature').value);
        formData.append('top_p', document.getElementById('topP').value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch('/Generate_testcases/api/workspace-generate/', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.error) {
                showMessage(data.error, 'error');
            } else {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = `/Generate_testcases/level2/${data.level2_id}/`;
                }, 1000);
            }
        } catch (err) {
            showMessage('ç”Ÿæˆå¤±è´¥', 'error');
        }
    }

    // ç¼–è¾‘ç§å­å†…å®¹
    function editSeedContent(seedId) {
        const contentDiv = document.querySelector(`.seed-content[data-seed-id="${seedId}"]`);
        const editBtn = document.querySelector(`.seed-action-btn[data-seed-id="${seedId}"][onclick*="editSeedContent"]`);

        if (contentDiv.contentEditable === 'true') {
            // ä¿å­˜æ¨¡å¼
            const newText = contentDiv.textContent.trim();

            if (!newText) {
                showMessage('ç§å­å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            saveSeedContent(seedId, newText, contentDiv, editBtn);
        } else {
            // ç¼–è¾‘æ¨¡å¼
            contentDiv.contentEditable = true;
            contentDiv.focus();
            contentDiv.classList.add('editing');
            editBtn.textContent = 'ä¿å­˜';
        }
    }

    // ä¿å­˜ç§å­å†…å®¹
    async function saveSeedContent(seedId, text, contentDiv, editBtn) {
        try {
            const response = await fetch('/Generate_testcases/api/update-seed/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({id: seedId, text: text})
            });

            const data = await response.json();

            if (data.error) {
                showMessage(data.error, 'error');
            } else {
                showMessage('ä¿å­˜æˆåŠŸ', 'success');
                contentDiv.contentEditable = false;
                contentDiv.classList.remove('editing');
                contentDiv.dataset.original = text;
                editBtn.textContent = 'ç¼–è¾‘';
            }
        } catch (err) {
            showMessage('ä¿å­˜å¤±è´¥', 'error');
        }
    }

    // å¤åˆ¶ç§å­æ–‡æœ¬
    function copySeedText(seedId) {
        const contentDiv = document.querySelector(`.seed-content[data-seed-id="${seedId}"]`);
        const text = contentDiv.textContent;

        navigator.clipboard.writeText(text).then(() => {
            showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
            showMessage('å¤åˆ¶å¤±è´¥', 'error');
        });
    }

    // åˆ é™¤å•ä¸ªç§å­
    async function deleteSingleSeed(seedId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç§å­æµ‹è¯•ç”¨ä¾‹å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch('/Generate_testcases/api/delete-items/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    level1_ids: [],
                    level2_ids: [],
                    seed_ids: [seedId]
                })
            });

            const data = await response.json();

            if (data.error) {
                showMessage(data.error, 'error');
            } else {
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                // é‡æ–°åŠ è½½ç§å­åˆ—è¡¨
                loadSeedList(currentLevel2Id);
            }
        } catch (err) {
            showMessage('åˆ é™¤å¤±è´¥', 'error');
        }
    }

    // æ‰¹é‡åˆ é™¤ç§å­
    async function batchDeleteSeeds() {
        const checkedBoxes = document.querySelectorAll('.seed-select-checkbox:checked');

        if (checkedBoxes.length === 0) {
            showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ç§å­', 'error');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedBoxes.length} ä¸ªç§å­æµ‹è¯•ç”¨ä¾‹å—ï¼Ÿ`)) {
            return;
        }

        const seedIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.seedId));

        try {
            const response = await fetch('/Generate_testcases/api/delete-items/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    level1_ids: [],
                    level2_ids: [],
                    seed_ids: seedIds
                })
            });

            const data = await response.json();

            if (data.error) {
                showMessage(data.error, 'error');
            } else {
                showMessage(`æˆåŠŸåˆ é™¤ ${checkedBoxes.length} ä¸ªç§å­`, 'success');
                // é‡æ–°åŠ è½½ç§å­åˆ—è¡¨
                loadSeedList(currentLevel2Id);
                // é‡ç½®å…¨é€‰çŠ¶æ€
                allSelected = false;
                document.getElementById('selectAllBtn').textContent = 'å…¨é€‰';
            }
        } catch (err) {
            showMessage('åˆ é™¤å¤±è´¥', 'error');
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = `message ${type} show`;
        setTimeout(() => {
            msg.classList.remove('show');
        }, 3000);
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });

    function triggerImport() {
        document.getElementById('importFileInput').click();
    }

    async function uploadImportFile(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;

        try {
            const fd = new FormData();
            fd.append('file', file);

            const resp = await fetch('api/import-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: fd
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                alert((data && data.msg) ? data.msg : 'å¯¼å…¥å¤±è´¥');
                return;
            }

            const s = data.stats || {};
            alert(`å¯¼å…¥æˆåŠŸï¼
æ–°å¢ä¸€çº§åŠŸèƒ½ï¼š${s.created_level1 || 0}
æ–°å¢äºŒçº§åŠŸèƒ½ï¼š${s.created_level2 || 0}
æ›´æ–°äºŒçº§promptï¼š${s.updated_level2_prompt || 0}
æ–°å¢ç§å­ï¼š${s.created_seed || 0}
è·³è¿‡è¡Œï¼š${s.skipped_rows || 0}`);

            // åˆ·æ–°ç•Œé¢ï¼Œè®©å·¦ä¾§ä¸€çº§åŠŸèƒ½/äºŒçº§/ç§å­é‡æ–°æ¸²æŸ“
            window.location.reload();
        } catch (e) {
            alert('å¯¼å…¥å¼‚å¸¸ï¼š' + e);
        } finally {
            // å…è®¸é‡å¤é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶ä¹Ÿèƒ½è§¦å‘ onchange
            event.target.value = '';
        }
    }

</script>
</body>
</html>
