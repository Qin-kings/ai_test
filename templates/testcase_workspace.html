<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•ç”¨ä¾‹å·¥ä½œå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }
    
    .workspace-container {
      display: flex;
      height: calc(100vh - 60px);
      gap: 0;
      margin-top: 60px;
    }
    
    .top-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 100;
    }
    
    .top-toolbar h2 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }
    
    .toolbar-actions {
      display: flex;
      gap: 10px;
    }
    
    .delete-mode-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .delete-mode-btn:hover {
      background: #d32f2f;
    }
    
    .delete-mode-btn.cancel-mode {
      background: #9e9e9e;
    }
    
    .delete-mode-btn.cancel-mode:hover {
      background: #757575;
    }
    
    .edit-mode-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 10px;
    }
    
    .edit-mode-btn:hover {
      background: #1976D2;
    }
    
    .edit-mode-btn.cancel-mode {
      background: #9e9e9e;
    }
    
    .edit-mode-btn.cancel-mode:hover {
      background: #757575;
    }
    
    .save-edit-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
      margin-left: 10px;
    }
    
    .save-edit-btn:hover {
      background: #45a049;
    }
    
    .save-edit-btn.show {
      display: block;
    }
    
    .confirm-delete-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
    }
    
    .confirm-delete-btn:hover {
      background: #d32f2f;
    }
    
    .confirm-delete-btn.show {
      display: block;
    }
    
    .panel {
      background: white;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e0e0;
    }
    
    .panel-header {
      padding: 16px 20px;
      border-bottom: 2px solid #4CAF50;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
    }
    
    .panel-header h3 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    .add-btn {
      background: #4CAF50;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .add-btn:hover {
      background: #45a049;
      transform: scale(1.1);
    }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .list-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .list-item-content {
      flex: 1;
    }
    
    .list-item-checkbox {
      display: none;
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .delete-mode .list-item-checkbox {
      display: block;
    }
    
    .list-item:hover {
      background: #f5f5f5;
    }
    
    .list-item.active {
      background: #e8f5e9;
      border-left-color: #4CAF50;
      font-weight: 500;
    }
    
    .list-item-name {
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
      outline: none;
      padding: 2px 6px;
      border-radius: 3px;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    
    .list-item-name.editable {
      cursor: text;
    }
    
    .list-item-name.editable:hover {
      background: #f5f5f5;
    }
    
    .list-item-name.editable:focus {
      background: #fff;
      box-shadow: 0 0 0 2px #2196F3;
    }
    
    .list-item-name.editing {
      background: #e3f2fd;
    }
    
    .list-item-meta {
      font-size: 12px;
      color: #999;
    }
    
    /* å·¦ä¾§é¢æ¿ - ä¸€çº§åŠŸèƒ½ */
    .level1-panel {
      width: 280px;
      min-width: 280px;
    }
    
    /* ä¸­é—´é¢æ¿ - äºŒçº§åŠŸèƒ½ */
    .level2-panel {
      width: 300px;
      min-width: 300px;
    }
    
    /* å³ä¾§é¢æ¿ - ç§å­å’Œç”Ÿæˆ */
    .seed-panel {
      flex: 1;
      border-right: none;
    }
    
    .prompt-display {
      background: #fff9e6;
      border: 1px solid #ffe082;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 20px;
      outline: none;
      min-height: 60px;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    
    .prompt-display p {
      margin: 0;
      padding: 0;
    }
    
    .prompt-display.editable {
      cursor: text;
    }
    
    .prompt-display.editable:hover {
      background: #fff8dc;
    }
    
    .prompt-display.editable:focus {
      background: #fff;
      box-shadow: 0 0 0 2px #ff9800;
    }
    
    .prompt-display.editing {
      background: #e3f2fd;
    }
    
    .prompt-display h4 {
      font-size: 13px;
      color: #f57c00;
      margin-bottom: 8px;
    }
    
    .prompt-display p {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .seed-list {
      padding: 12px 20px;
    }
    
    .seed-item {
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .seed-item-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      justify-content: space-between;
    }
    
    .seed-item-left {
      display: flex;
      align-items: center;
    }
    
    .seed-delete-checkbox {
      display: none;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .delete-mode .seed-delete-checkbox {
      display: block;
    }
    
    .seed-checkbox {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .seed-item-content {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 8px;
      padding: 8px 8px 8px 28px;
      outline: none;
      white-space: pre-wrap;
      min-height: 40px;
      border-radius: 4px;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    
    .seed-item-content.editable {
      cursor: text;
    }
    
    .seed-item-content.editable:hover {
      background: #f0f0f0;
    }
    
    .seed-item-content.editable:focus {
      background: #fff;
      box-shadow: 0 0 0 2px #2196F3;
    }
    
    .seed-item-content.editing {
      background: #e3f2fd;
    }
    
    .seed-item-footer {
      display: flex;
      align-items: center;
      padding-left: 28px;
      gap: 10px;
    }
    
    .seed-item-footer label {
      font-size: 12px;
      color: #666;
    }
    
    .seed-item-footer input[type="number"] {
      width: 80px;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .seed-item-footer .seed-meta {
      margin-left: auto;
      font-size: 11px;
      color: #999;
    }
    
    .generate-section {
      background: white;
      border-top: 2px solid #4CAF50;
      padding: 20px;
      position: sticky;
      bottom: 0;
    }
    
    .generate-params {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .param-group {
      display: flex;
      flex-direction: column;
    }
    
    .param-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .param-group input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .generate-btn {
      width: 100%;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .generate-btn:hover {
      background: #45a049;
    }
    
    .generate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* Modalæ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      font-size: 18px;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 2000;
      display: none;
    }
    
    .message.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    .message.success {
      background: #4CAF50;
      color: white;
    }
    
    .message.error {
      background: #f44336;
      color: white;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div class="top-toolbar">
    <h2>æµ‹è¯•ç”¨ä¾‹å·¥ä½œå°</h2>
    <div class="toolbar-actions">
      <button class="edit-mode-btn" id="editModeBtn" onclick="toggleEditMode()">ç¼–è¾‘</button>
      <button class="save-edit-btn" id="saveEditBtn" onclick="saveEdits()">ä¿å­˜ä¿®æ”¹</button>
      <button class="delete-mode-btn" id="deleteModeBtn" onclick="toggleDeleteMode()">åˆ é™¤</button>
      <button class="confirm-delete-btn" id="confirmDeleteBtn" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
    </div>
  </div>
  
  <div class="workspace-container" id="workspaceContainer">
    <!-- å·¦ä¾§ï¼šä¸€çº§åŠŸèƒ½åˆ—è¡¨ -->
    <div class="panel level1-panel">
      <div class="panel-header">
        <h3>ä¸€çº§åŠŸèƒ½</h3>
        <button class="add-btn" onclick="showAddLevel1Modal()" title="æ·»åŠ ä¸€çº§åŠŸèƒ½">+</button>
      </div>
      <div class="panel-content" id="level1List">
        {% for level1 in level1_list %}
        <div class="list-item" data-id="{{ level1.id }}" onclick="selectLevel1({{ level1.id }}, this)">
          <div class="list-item-content">
            <div class="list-item-name" data-type="level1" data-id="{{ level1.id }}" data-original="{{ level1.name }}">{{ level1.name }}</div>
            {% if level1.code %}
            <div class="list-item-meta">ç¼–ç : {{ level1.code }}</div>
            {% endif %}
          </div>
          <input type="checkbox" class="list-item-checkbox" data-type="level1" data-id="{{ level1.id }}" onclick="event.stopPropagation()">
        </div>
        {% empty %}
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“‹</div>
          <p>æš‚æ— ä¸€çº§åŠŸèƒ½<br>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- ä¸­é—´ï¼šäºŒçº§åŠŸèƒ½åˆ—è¡¨ -->
    <div class="panel level2-panel">
      <div class="panel-header">
        <h3>äºŒçº§åŠŸèƒ½</h3>
        <button class="add-btn" id="addLevel2Btn" onclick="showAddLevel2Modal()" title="æ·»åŠ äºŒçº§åŠŸèƒ½" disabled>+</button>
      </div>
      <div class="panel-content" id="level2List">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“</div>
          <p>è¯·å…ˆé€‰æ‹©ä¸€çº§åŠŸèƒ½</p>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§ï¼šç§å­æµ‹è¯•ç”¨ä¾‹å’Œç”Ÿæˆ -->
    <div class="panel seed-panel">
      <div class="panel-header">
        <h3>ç§å­æµ‹è¯•ç”¨ä¾‹</h3>
        <button class="add-btn" id="addSeedBtn" onclick="showAddSeedModal()" title="æ·»åŠ ç§å­ç”¨ä¾‹" disabled>+</button>
      </div>
      
      <!-- åœºæ™¯æç¤ºè¯æ˜¾ç¤ºåŒº -->
      <div id="promptDisplay" style="display: none;">
        <!-- åŠ¨æ€å†…å®¹ -->
      </div>
      
      <!-- ç§å­åˆ—è¡¨ -->
      <div class="panel-content" id="seedList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸŒ±</div>
          <p>è¯·å…ˆé€‰æ‹©äºŒçº§åŠŸèƒ½</p>
        </div>
      </div>
      
      <!-- ç”ŸæˆæŒ‰é’®åŒº -->
      <div class="generate-section" id="generateSection" style="display: none;">
        <div class="generate-params">
          <div class="param-group">
            <label>Temperature</label>
            <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2">
          </div>
          <div class="param-group">
            <label>Top P</label>
            <input type="number" id="topP" value="1.0" step="0.1" min="0" max="1">
          </div>
        </div>
        <button class="generate-btn" onclick="generateTestcases()">ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</button>
      </div>
    </div>
  </div>
  
  <!-- æ·»åŠ ä¸€çº§åŠŸèƒ½æ¨¡æ€æ¡† -->
  <div class="modal" id="addLevel1Modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ·»åŠ ä¸€çº§åŠŸèƒ½</h3>
        <button class="modal-close" onclick="closeModal('addLevel1Modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>åç§° <span style="color: red;">*</span></label>
          <input type="text" id="level1Name" placeholder="è¾“å…¥ä¸€çº§åŠŸèƒ½åç§°">
        </div>
        <div class="form-group">
          <label>ç¼–ç </label>
          <input type="text" id="level1Code" placeholder="å¯é€‰ï¼šç¼–ç /ä¸šåŠ¡Key">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addLevel1Modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitAddLevel1()">ç¡®å®š</button>
      </div>
    </div>
  </div>
  
  <!-- æ·»åŠ äºŒçº§åŠŸèƒ½æ¨¡æ€æ¡† -->
  <div class="modal" id="addLevel2Modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ·»åŠ äºŒçº§åŠŸèƒ½</h3>
        <button class="modal-close" onclick="closeModal('addLevel2Modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>åç§° <span style="color: red;">*</span></label>
          <input type="text" id="level2Name" placeholder="è¾“å…¥äºŒçº§åŠŸèƒ½åç§°">
        </div>
        <div class="form-group">
          <label>ç¼–ç </label>
          <input type="text" id="level2Code" placeholder="å¯é€‰ï¼šç¼–ç ">
        </div>
        <div class="form-group">
          <label>åœºæ™¯æç¤ºè¯</label>
          <textarea id="level2Prompt" placeholder="è¾“å…¥è¯¥äºŒçº§åŠŸèƒ½ï¼ˆåœºæ™¯ï¼‰çš„æç¤ºè¯"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addLevel2Modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitAddLevel2()">ç¡®å®š</button>
      </div>
    </div>
  </div>
  
  <!-- æ·»åŠ ç§å­ç”¨ä¾‹æ¨¡æ€æ¡† -->
  <div class="modal" id="addSeedModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ·»åŠ ç§å­æµ‹è¯•ç”¨ä¾‹</h3>
        <button class="modal-close" onclick="closeModal('addSeedModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>æµ‹è¯•ç”¨ä¾‹å†…å®¹ <span style="color: red;">*</span></label>
          <textarea id="seedText" placeholder="è¾“å…¥æµ‹è¯•ç”¨ä¾‹å†…å®¹..." rows="6"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addSeedModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitAddSeed()">ç¡®å®š</button>
      </div>
    </div>
  </div>
  
  <!-- æ¶ˆæ¯æç¤º -->
  <div class="message" id="message"></div>
  
  <script>
    // å…¨å±€çŠ¶æ€
    let currentLevel1Id = null;
    let currentLevel2Id = null;
    let deleteMode = false;
    let editMode = false;
    let editedItems = new Map(); // å­˜å‚¨ä¿®æ”¹çš„å†…å®¹
    
    // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
    function toggleEditMode() {
      editMode = !editMode;
      const editModeBtn = document.getElementById('editModeBtn');
      const saveBtn = document.getElementById('saveEditBtn');
      
      if (editMode) {
        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        editModeBtn.classList.add('cancel-mode');
        editModeBtn.textContent = 'å–æ¶ˆç¼–è¾‘';
        saveBtn.classList.add('show');
        
        // å¯ç”¨æ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ 
        enableEditing();
      } else {
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        editModeBtn.classList.remove('cancel-mode');
        editModeBtn.textContent = 'ç¼–è¾‘';
        saveBtn.classList.remove('show');
        
        // ç¦ç”¨ç¼–è¾‘å¹¶æ¢å¤åŸå§‹å†…å®¹
        disableEditing();
        editedItems.clear();
      }
    }
    
    // å¯ç”¨ç¼–è¾‘
    function enableEditing() {
      // ä¸€çº§åŠŸèƒ½åç§°
      document.querySelectorAll('.list-item-name[data-type="level1"]').forEach(el => {
        el.contentEditable = true;
        el.classList.add('editable');
        el.addEventListener('input', onLevel1NameChange);
      });
      
      // äºŒçº§åŠŸèƒ½åç§°
      document.querySelectorAll('.list-item-name[data-type="level2"]').forEach(el => {
        el.contentEditable = true;
        el.classList.add('editable');
        el.addEventListener('input', onLevel2NameChange);
      });
      
      // åœºæ™¯æç¤ºè¯
      const promptEl = document.querySelector('#promptDisplay p[data-level2-id]');
      if (promptEl) {
        promptEl.contentEditable = true;
        promptEl.classList.add('editable');
        promptEl.addEventListener('input', onPromptChange);
        // æ¸…é™¤æç¤ºæ–‡æœ¬
        if (promptEl.innerHTML.includes('<em')) {
          promptEl.innerHTML = '';
        }
      }
      
      // ç§å­æµ‹è¯•ç”¨ä¾‹
      document.querySelectorAll('.seed-item-content[data-seed-id]').forEach(el => {
        el.contentEditable = true;
        el.classList.add('editable');
        el.addEventListener('input', onSeedContentChange);
      });
    }
    
    // ç¦ç”¨ç¼–è¾‘
    function disableEditing() {
      // ä¸€çº§åŠŸèƒ½åç§°
      document.querySelectorAll('.list-item-name[data-type="level1"]').forEach(el => {
        el.contentEditable = false;
        el.classList.remove('editable', 'editing');
        el.textContent = el.dataset.original;
        el.removeEventListener('input', onLevel1NameChange);
      });
      
      // äºŒçº§åŠŸèƒ½åç§°
      document.querySelectorAll('.list-item-name[data-type="level2"]').forEach(el => {
        el.contentEditable = false;
        el.classList.remove('editable', 'editing');
        el.textContent = el.dataset.original;
        el.removeEventListener('input', onLevel2NameChange);
      });
      
      // åœºæ™¯æç¤ºè¯
      const promptEl = document.querySelector('#promptDisplay p[data-level2-id]');
      if (promptEl) {
        promptEl.contentEditable = false;
        promptEl.classList.remove('editable', 'editing');
        const original = promptEl.dataset.original;
        if (original) {
          promptEl.textContent = original;
        } else {
          promptEl.innerHTML = '<em style="color: #999;">æœªè®¾ç½®ï¼ˆç‚¹å‡»ç¼–è¾‘æŒ‰é’®åå¯è¾“å…¥ï¼‰</em>';
        }
        promptEl.removeEventListener('input', onPromptChange);
      }
      
      // ç§å­æµ‹è¯•ç”¨ä¾‹
      document.querySelectorAll('.seed-item-content[data-seed-id]').forEach(el => {
        el.contentEditable = false;
        el.classList.remove('editable', 'editing');
        el.textContent = el.dataset.original;
        el.removeEventListener('input', onSeedContentChange);
      });
    }
    
    // ç›‘å¬ä¸€çº§åŠŸèƒ½åç§°å˜åŒ–
    function onLevel1NameChange(e) {
      const el = e.target;
      const id = el.dataset.id;
      const newName = el.textContent.trim();
      el.classList.add('editing');
      editedItems.set(`level1_${id}`, { type: 'level1', id, name: newName });
    }
    
    // ç›‘å¬äºŒçº§åŠŸèƒ½åç§°å˜åŒ–
    function onLevel2NameChange(e) {
      const el = e.target;
      const id = el.dataset.id;
      const newName = el.textContent.trim();
      el.classList.add('editing');
      
      // è·å–å½“å‰å­˜å‚¨çš„é¡¹ï¼ˆå¯èƒ½å·²ç»åŒ…å«promptï¼‰
      const existingItem = editedItems.get(`level2_${id}`);
      
      editedItems.set(`level2_${id}`, { 
        type: 'level2', 
        id, 
        name: newName,
        prompt: existingItem?.prompt // ä¿ç•™å·²æœ‰çš„promptä¿®æ”¹
      });
    }
    
    // ç›‘å¬æç¤ºè¯å˜åŒ–
    function onPromptChange(e) {
      const el = e.target;
      const id = el.dataset.level2Id || currentLevel2Id;
      const newPrompt = el.textContent.trim();
      
      // å¦‚æœå†…å®¹æ˜¯ç©ºçš„æç¤ºæ–‡æœ¬ï¼Œåˆ™æ¸…ç©º
      if (el.innerHTML.includes('<em')) {
        el.innerHTML = '';
      }
      
      el.classList.add('editing');
      
      // éœ€è¦åŒæ—¶æ›´æ–°äºŒçº§åŠŸèƒ½çš„åç§°ï¼ˆå› ä¸ºæç¤ºè¯å±äºäºŒçº§åŠŸèƒ½ï¼‰
      const level2Name = document.querySelector(`.list-item-name[data-type="level2"][data-id="${id}"]`);
      const currentName = level2Name ? level2Name.textContent.trim() : '';
      
      editedItems.set(`level2_${id}`, { 
        type: 'level2', 
        id, 
        name: currentName,
        prompt: newPrompt 
      });
    }
    
    // ç›‘å¬ç§å­å†…å®¹å˜åŒ–
    function onSeedContentChange(e) {
      const el = e.target;
      const id = el.dataset.seedId;
      const newText = el.textContent.trim();
      el.classList.add('editing');
      editedItems.set(`seed_${id}`, { type: 'seed', id, text: newText });
    }
    
    // ä¿å­˜æ‰€æœ‰ä¿®æ”¹
    async function saveEdits() {
      if (editedItems.size === 0) {
        showMessage('æ²¡æœ‰éœ€è¦ä¿å­˜çš„ä¿®æ”¹', 'info');
        return;
      }
      
      const updates = Array.from(editedItems.values());
      let successCount = 0;
      let errorCount = 0;
      
      for (const item of updates) {
        try {
          if (item.type === 'level1') {
            await updateLevel1(item.id, item.name);
          } else if (item.type === 'level2') {
            await updateLevel2(item.id, item.name, item.prompt);
          } else if (item.type === 'seed') {
            await updateSeed(item.id, item.text);
          }
          successCount++;
        } catch (err) {
          errorCount++;
          console.error('ä¿å­˜å¤±è´¥:', err);
        }
      }
      
      if (errorCount === 0) {
        showMessage(`æˆåŠŸä¿å­˜ ${successCount} é¡¹ä¿®æ”¹`, 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showMessage(`ä¿å­˜å®Œæˆï¼šæˆåŠŸ ${successCount} é¡¹ï¼Œå¤±è´¥ ${errorCount} é¡¹`, 'warning');
        setTimeout(() => location.reload(), 2000);
      }
    }
    
    // æ›´æ–°ä¸€çº§åŠŸèƒ½
    function updateLevel1(id, name) {
      return fetch('/Generate_testcases/api/update-level1/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ id, name })
      }).then(res => res.json()).then(data => {
        if (data.error) throw new Error(data.error);
      });
    }
    
    // æ›´æ–°äºŒçº§åŠŸèƒ½
    function updateLevel2(id, name, prompt) {
      return fetch('/Generate_testcases/api/update-level2/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ id, name, prompt })
      }).then(res => res.json()).then(data => {
        if (data.error) throw new Error(data.error);
      });
    }
    
    // æ›´æ–°ç§å­ç”¨ä¾‹
    function updateSeed(id, text) {
      return fetch('/Generate_testcases/api/update-seed/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ id, text })
      }).then(res => res.json()).then(data => {
        if (data.error) throw new Error(data.error);
      });
    }
    
    // åˆ‡æ¢åˆ é™¤æ¨¡å¼
    function toggleDeleteMode() {
      deleteMode = !deleteMode;
      const container = document.getElementById('workspaceContainer');
      const deleteModeBtn = document.getElementById('deleteModeBtn');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      if (deleteMode) {
        container.classList.add('delete-mode');
        deleteModeBtn.classList.add('cancel-mode');
        deleteModeBtn.textContent = 'å–æ¶ˆ';
        confirmBtn.classList.add('show');
      } else {
        container.classList.remove('delete-mode');
        deleteModeBtn.classList.remove('cancel-mode');
        deleteModeBtn.textContent = 'åˆ é™¤';
        confirmBtn.classList.remove('show');
        // å–æ¶ˆæ‰€æœ‰é€‰ä¸­
        document.querySelectorAll('.list-item-checkbox, .seed-delete-checkbox').forEach(cb => cb.checked = false);
      }
    }
    
    // ç¡®è®¤åˆ é™¤
    function confirmDelete() {
      const level1Ids = [];
      const level2Ids = [];
      const seedIds = [];
      
      // æ”¶é›†é€‰ä¸­çš„é¡¹
      document.querySelectorAll('.list-item-checkbox:checked').forEach(cb => {
        const type = cb.dataset.type;
        const id = parseInt(cb.dataset.id);
        if (type === 'level1') level1Ids.push(id);
        if (type === 'level2') level2Ids.push(id);
      });
      
      document.querySelectorAll('.seed-delete-checkbox:checked').forEach(cb => {
        seedIds.push(parseInt(cb.dataset.seedId));
      });
      
      if (level1Ids.length === 0 && level2Ids.length === 0 && seedIds.length === 0) {
        showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹è¦åˆ é™¤çš„å†…å®¹', 'error');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${level1Ids.length + level2Ids.length + seedIds.length} é¡¹å—ï¼Ÿ\nåˆ é™¤ä¸€çº§åŠŸèƒ½ä¼šåŒæ—¶åˆ é™¤å…¶ä¸‹çš„æ‰€æœ‰äºŒçº§åŠŸèƒ½å’Œç§å­ã€‚\nåˆ é™¤äºŒçº§åŠŸèƒ½ä¼šåŒæ—¶åˆ é™¤å…¶ä¸‹çš„æ‰€æœ‰ç§å­ã€‚`)) {
        return;
      }
      
      fetch('/Generate_testcases/api/delete-items/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          level1_ids: level1Ids,
          level2_ids: level2Ids,
          seed_ids: seedIds
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message, 'success');
          // åˆ·æ–°é¡µé¢
          setTimeout(() => location.reload(), 1000);
        }
      })
      .catch(err => showMessage('åˆ é™¤å¤±è´¥', 'error'));
    }
    
    // é€‰æ‹©ä¸€çº§åŠŸèƒ½
    function selectLevel1(id, element) {
      currentLevel1Id = id;
      currentLevel2Id = null;
      
      // æ›´æ–°UI
      document.querySelectorAll('.level1-panel .list-item').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      
      // å¯ç”¨æ·»åŠ äºŒçº§åŠŸèƒ½æŒ‰é’®
      document.getElementById('addLevel2Btn').disabled = false;
      
      // åŠ è½½äºŒçº§åŠŸèƒ½åˆ—è¡¨
      loadLevel2List(id);
      
      // æ¸…ç©ºç§å­åˆ—è¡¨
      clearSeedPanel();
    }
    
    // åŠ è½½äºŒçº§åŠŸèƒ½åˆ—è¡¨
    function loadLevel2List(level1Id) {
      fetch(`/Generate_testcases/api/get-level2-list/?level1_id=${level1Id}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('level2List');
          if (data.level2_list && data.level2_list.length > 0) {
            container.innerHTML = data.level2_list.map(l2 => `
              <div class="list-item" data-id="${l2.id}" onclick="selectLevel2(${l2.id}, this)">
                <div class="list-item-content">
                  <div class="list-item-name" data-type="level2" data-id="${l2.id}" data-original="${l2.name}">${l2.name}</div>
                  ${l2.prompt ? `<div class="list-item-meta">å·²è®¾ç½®æç¤ºè¯</div>` : ''}
                </div>
                <input type="checkbox" class="list-item-checkbox" data-type="level2" data-id="${l2.id}" onclick="event.stopPropagation()">
              </div>
            `).join('');
            
            // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå¯ç”¨æ–°åŠ è½½çš„å…ƒç´ 
            if (editMode) {
              container.querySelectorAll('.list-item-name[data-type="level2"]').forEach(el => {
                el.contentEditable = true;
                el.classList.add('editable');
                el.addEventListener('input', onLevel2NameChange);
              });
            }
          } else {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <p>æš‚æ— äºŒçº§åŠŸèƒ½<br>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
              </div>
            `;
          }
        })
        .catch(err => showMessage('åŠ è½½äºŒçº§åŠŸèƒ½åˆ—è¡¨å¤±è´¥', 'error'));
    }
    
    // é€‰æ‹©äºŒçº§åŠŸèƒ½
    function selectLevel2(id, element) {
      currentLevel2Id = id;
      
      // æ›´æ–°UI
      document.querySelectorAll('.level2-panel .list-item').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      
      // å¯ç”¨æ·»åŠ ç§å­æŒ‰é’®
      document.getElementById('addSeedBtn').disabled = false;
      
      // åŠ è½½ç§å­åˆ—è¡¨
      loadSeedList(id);
    }
    
    // åŠ è½½ç§å­åˆ—è¡¨
    function loadSeedList(level2Id) {
      fetch(`/Generate_testcases/api/get-seed-list/?level2_id=${level2Id}`)
        .then(res => res.json())
        .then(data => {
          // æ˜¾ç¤ºæç¤ºè¯
          const promptDisplay = document.getElementById('promptDisplay');
          if (data.prompt) {
            promptDisplay.style.display = 'block';
            promptDisplay.innerHTML = `
              <h4>åœºæ™¯æç¤ºè¯</h4>
              <p contenteditable="false" data-original="${data.prompt.replace(/"/g, '&quot;')}" data-level2-id="${level2Id}">${data.prompt}</p>
            `;
          } else {
            promptDisplay.style.display = 'block';
            promptDisplay.innerHTML = `
              <h4>åœºæ™¯æç¤ºè¯</h4>
              <p contenteditable="false" data-original="" data-level2-id="${level2Id}"><em style="color: #999;">æœªè®¾ç½®ï¼ˆç‚¹å‡»ç¼–è¾‘æŒ‰é’®åå¯è¾“å…¥ï¼‰</em></p>
            `;
          }
          
          // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå¯ç”¨æç¤ºè¯ç¼–è¾‘
          if (editMode) {
            const promptP = promptDisplay.querySelector('p');
            promptP.contentEditable = true;
            promptP.classList.add('editable');
            promptP.addEventListener('input', onPromptChange);
          }
          
          // æ˜¾ç¤ºç§å­åˆ—è¡¨
          const container = document.getElementById('seedList');
          if (data.seed_list && data.seed_list.length > 0) {
            container.innerHTML = `
              <div class="seed-list">
                ${data.seed_list.map(seed => `
                  <div class="seed-item">
                    <div class="seed-item-header">
                      <div class="seed-item-left">
                        <input type="checkbox" class="seed-checkbox" data-seed-id="${seed.id}" onchange="updateGenerateBtn()">
                      </div>
                      <input type="checkbox" class="seed-delete-checkbox" data-seed-id="${seed.id}" onclick="event.stopPropagation()">
                    </div>
                    <div class="seed-item-content" data-seed-id="${seed.id}" data-original="${seed.text.replace(/"/g, '&quot;')}" contenteditable="false">${seed.text}</div>
                    <div class="seed-item-footer">
                      <label>ç”Ÿæˆæ•°é‡:</label>
                      <input type="number" class="seed-n-input" data-seed-id="${seed.id}" value="5" min="1" max="50" disabled>
                      <span class="seed-meta">${seed.created_at}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
            
            // æ·»åŠ checkboxè”åŠ¨
            document.querySelectorAll('.seed-checkbox').forEach(cb => {
              cb.addEventListener('change', function() {
                const seedId = this.dataset.seedId;
                const input = document.querySelector(`.seed-n-input[data-seed-id="${seedId}"]`);
                input.disabled = !this.checked;
              });
            });
            
            // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå¯ç”¨ç§å­å†…å®¹ç¼–è¾‘
            if (editMode) {
              document.querySelectorAll('.seed-item-content[data-seed-id]').forEach(el => {
                el.contentEditable = true;
                el.classList.add('editable');
                el.addEventListener('input', onSeedContentChange);
              });
            }
            
            // æ˜¾ç¤ºç”ŸæˆåŒºåŸŸ
            document.getElementById('generateSection').style.display = 'block';
          } else {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸŒ±</div>
                <p>æš‚æ— ç§å­æµ‹è¯•ç”¨ä¾‹<br>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
              </div>
            `;
            document.getElementById('generateSection').style.display = 'none';
          }
        })
        .catch(err => showMessage('åŠ è½½ç§å­åˆ—è¡¨å¤±è´¥', 'error'));
    }
    
    // æ¸…ç©ºç§å­é¢æ¿
    function clearSeedPanel() {
      document.getElementById('promptDisplay').style.display = 'none';
      document.getElementById('seedList').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸŒ±</div>
          <p>è¯·å…ˆé€‰æ‹©äºŒçº§åŠŸèƒ½</p>
        </div>
      `;
      document.getElementById('generateSection').style.display = 'none';
      document.getElementById('addSeedBtn').disabled = true;
    }
    
    // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
    function updateGenerateBtn() {
      const checked = document.querySelectorAll('.seed-checkbox:checked').length;
      const btn = document.querySelector('.generate-btn');
      btn.disabled = checked === 0;
    }
    
    // Modalæ“ä½œ
    function showAddLevel1Modal() {
      document.getElementById('level1Name').value = '';
      document.getElementById('level1Code').value = '';
      document.getElementById('addLevel1Modal').classList.add('show');
    }
    
    function showAddLevel2Modal() {
      if (!currentLevel1Id) {
        showMessage('è¯·å…ˆé€‰æ‹©ä¸€çº§åŠŸèƒ½', 'error');
        return;
      }
      document.getElementById('level2Name').value = '';
      document.getElementById('level2Code').value = '';
      document.getElementById('level2Prompt').value = '';
      document.getElementById('addLevel2Modal').classList.add('show');
    }
    
    function showAddSeedModal() {
      if (!currentLevel2Id) {
        showMessage('è¯·å…ˆé€‰æ‹©äºŒçº§åŠŸèƒ½', 'error');
        return;
      }
      document.getElementById('seedText').value = '';
      document.getElementById('addSeedModal').classList.add('show');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }
    
    // æäº¤æ·»åŠ ä¸€çº§åŠŸèƒ½
    function submitAddLevel1() {
      const name = document.getElementById('level1Name').value.trim();
      const code = document.getElementById('level1Code').value.trim();
      
      if (!name) {
        showMessage('è¯·è¾“å…¥åç§°', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('name', name);
      formData.append('code', code);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch('/Generate_testcases/api/add-level1/', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message, 'success');
          closeModal('addLevel1Modal');
          // åˆ·æ–°åˆ—è¡¨
          location.reload();
        }
      })
      .catch(err => showMessage('æ·»åŠ å¤±è´¥', 'error'));
    }
    
    // æäº¤æ·»åŠ äºŒçº§åŠŸèƒ½
    function submitAddLevel2() {
      const name = document.getElementById('level2Name').value.trim();
      const code = document.getElementById('level2Code').value.trim();
      const prompt = document.getElementById('level2Prompt').value.trim();
      
      if (!name) {
        showMessage('è¯·è¾“å…¥åç§°', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('level1_id', currentLevel1Id);
      formData.append('name', name);
      formData.append('code', code);
      formData.append('prompt', prompt);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch('/Generate_testcases/api/add-level2/', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message, 'success');
          closeModal('addLevel2Modal');
          // åˆ·æ–°äºŒçº§åŠŸèƒ½åˆ—è¡¨
          loadLevel2List(currentLevel1Id);
        }
      })
      .catch(err => showMessage('æ·»åŠ å¤±è´¥', 'error'));
    }
    
    // æäº¤æ·»åŠ ç§å­ç”¨ä¾‹
    function submitAddSeed() {
      const text = document.getElementById('seedText').value.trim();
      
      if (!text) {
        showMessage('è¯·è¾“å…¥æµ‹è¯•ç”¨ä¾‹å†…å®¹', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('level2_id', currentLevel2Id);
      formData.append('text', text);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch('/Generate_testcases/api/add-seed/', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message, 'success');
          closeModal('addSeedModal');
          // åˆ·æ–°ç§å­åˆ—è¡¨
          loadSeedList(currentLevel2Id);
        }
      })
      .catch(err => showMessage('æ·»åŠ å¤±è´¥', 'error'));
    }
    
    // ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
    function generateTestcases() {
      const checkedBoxes = document.querySelectorAll('.seed-checkbox:checked');
      if (checkedBoxes.length === 0) {
        showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç§å­æµ‹è¯•ç”¨ä¾‹', 'error');
        return;
      }
      
      const seedConfigs = [];
      checkedBoxes.forEach(cb => {
        const seedId = cb.dataset.seedId;
        const n = document.querySelector(`.seed-n-input[data-seed-id="${seedId}"]`).value;
        seedConfigs.push({seed_id: parseInt(seedId), n: parseInt(n)});
      });
      
      const formData = new FormData();
      formData.append('level2_id', currentLevel2Id);
      formData.append('seed_configs', JSON.stringify(seedConfigs));
      formData.append('prompt', '');  // å¯é€‰ï¼šä¼šè¯çº§åˆ«æç¤ºè¯
      formData.append('temperature', document.getElementById('temperature').value);
      formData.append('top_p', document.getElementById('topP').value);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      fetch('/Generate_testcases/api/workspace-generate/', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message, 'success');
          // è·³è½¬åˆ°æŸ¥çœ‹ç”Ÿæˆç»“æœé¡µé¢
          setTimeout(() => {
            window.location.href = `/Generate_testcases/level2/${data.level2_id}/`;
          }, 1000);
        }
      })
      .catch(err => showMessage('ç”Ÿæˆå¤±è´¥', 'error'));
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type} show`;
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('show');
        }
      });
    });
  </script>
</body>
</html>
